<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NGFW Best Practice Assessment (Offline)</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --ink: #1c1f23;
      --muted: #5e6b75;
      --accent: #ff6a00;
      --accent-dark: #e45700;
      --panel: #ffffff;
      --line: #e7ebef;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 400px at 20% -10%, #fff2e8 0%, transparent 60%),
        radial-gradient(900px 300px at 90% 10%, #e8f6ff 0%, transparent 55%),
        var(--bg);
      margin: 0;
      padding: 32px 20px 80px;
    }

    h1, h2, h3 {
      font-family: "Georgia", "Palatino Linotype", "Book Antiqua", serif;
      letter-spacing: 0.2px;
    }

    .container {
      max-width: 1120px;
      margin: 0 auto;
    }

    .hero {
      background: var(--panel);
      border-radius: 16px;
      padding: 24px 26px;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
    }

    .hero-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .brand img {
      height: 40px;
      width: auto;
    }

    .brand-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title h1 {
      margin: 0;
      font-size: 28px;
      color: var(--accent);
    }

    .version {
      font-size: 12px;
      font-weight: 600;
      color: #7a7a7a;
      margin-left: 6px;
    }

    .brand-title span {
      color: var(--muted);
      font-size: 14px;
    }

    .feature-tag {
      color: #5c3b1e;
      background: #fff3e6;
      border: 1px solid #ffd8a8;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
      width: fit-content;
    }

    .upload {
      margin-top: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .upload input[type="file"] {
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .upload button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(255, 106, 0, 0.25);
    }

    .upload button:hover {
      background: var(--accent-dark);
    }

    .notice {
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #fff6e6;
      border: 1px solid #ffd8a8;
      color: #4a3b2a;
      font-size: 13px;
      line-height: 1.4;
    }

    .notice a {
      color: #b45309;
      text-decoration: none;
      font-weight: 600;
    }

    .notice a:hover {
      text-decoration: underline;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .summary-box {
      background: var(--panel);
      padding: 20px;
      border-radius: 8px;
      flex: 1;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
    }

    .chart-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    .donut {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: conic-gradient(#28a745 0deg, #28a745 0deg, #ff4d4d 0deg, #ff4d4d 0deg, #cbd5e1 0deg);
      position: relative;
      flex: 0 0 auto;
    }

    .donut::after {
      content: "";
      position: absolute;
      inset: 10px;
      background: var(--panel);
      border-radius: 50%;
      box-shadow: inset 0 0 0 1px var(--line);
    }

    .donut-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
      z-index: 1;
    }

    .donut-center strong {
      font-size: 18px;
      color: #222;
    }

    .chart-legend {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: #333;
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-pass {
      background: #28a745;
    }

    .legend-fail {
      background: #ff4d4d;
    }

    .coverage {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .coverage-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
    }

    .coverage-card h4 {
      margin: 0 0 8px;
      font-size: 14px;
    }

    .coverage-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .coverage-bar {
      height: 8px;
      background: #f1f3f5;
      border-radius: 999px;
      overflow: hidden;
    }

    .coverage-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6a00, #ff8f1f);
      width: 0%;
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      margin: 10px 0 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar button {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      box-shadow: var(--shadow);
    }

    .filter-bar button.active {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }

    .site-footer {
      margin: 30px 0 10px;
      padding-top: 16px;
      border-top: 1px solid var(--line);
      color: #667085;
      font-size: 12px;
      line-height: 1.4;
    }

    .site-footer strong {
      color: #3a3a3a;
    }

    .export-btn {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      box-shadow: var(--shadow);
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .export-btn:hover {
      border-color: #ffb37f;
    }

    .section {
      margin-top: 20px;
    }

    .section h2 {
      margin: 18px 0 8px;
      font-size: 18px;
    }

    .section h3 {
      margin: 6px 0 12px;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    .section-note {
      margin: 4px 0 16px;
      color: #667085;
      font-size: 14px;
    }

    .control {
      background: var(--panel);
      border-radius: 8px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--line);
    }

    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      cursor: pointer;
      gap: 10px;
    }

    .control-header.fail {
      background: transparent;
      color: inherit;
      border-left: 6px solid #ff4d4d;
    }

    .control-header.pass {
      background: transparent;
      color: inherit;
      border-left: 6px solid #28a745;
    }

    .control-header.manual {
      background: transparent;
      color: inherit;
      border-left: 6px solid #6c757d;
    }

    .control-header.warn {
      background: transparent;
      color: inherit;
      border-left: 6px solid #f0ad4e;
    }

    .badges span {
      margin-left: 6px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }

    .expand-hint {
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f1f3f5;
      color: #667085;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chevron {
      display: inline-block;
      transition: transform 0.2s ease;
    }

    .control.expanded .chevron {
      transform: rotate(90deg);
    }

    .exclude-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 6px;
      font-size: 12px;
      color: #444;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed #d0d5dd;
      background: #fafafa;
      cursor: pointer;
      user-select: none;
    }

    .exclude-toggle input {
      margin: 0;
    }

    .control.excluded {
      opacity: 0.55;
    }

    .section-badge {
      background: #f1f3f5;
      color: #444;
    }

    .cis {
      background: #eee;
    }

    .stig {
      background: #e7eef8;
      color: #1b2a4e;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .stig img {
      width: 14px;
      height: 14px;
      display: block;
    }

    .fail {
      background: #ff4d4d;
      color: white;
    }

    .pass {
      background: #28a745;
      color: white;
    }

    .manual {
      background: #6c757d;
      color: white;
    }

    .badges span.warn {
      background: #f0ad4e;
      color: white;
    }

    .warn {
      background: #f0ad4e;
      color: white;
    }

    .details {
      display: none;
      padding: 14px;
      border-top: 1px solid var(--line);
      background: #fafbfc;
    }

    .rule {
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #ccc;
    }

    .ok {
      color: green;
      font-weight: bold;
    }

    .bad {
      color: red;
      font-weight: bold;
    }

    @media (max-width: 720px) {
      .summary {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    function toggle(id) {
      const el = document.getElementById(id);
      const control = el ? el.closest(".control") : null;
      const header = control ? control.querySelector(".control-header") : null;
      const isHidden = window.getComputedStyle(el).display === "none";
      el.style.display = isHidden ? "block" : "none";
      if (control) {
        control.classList.toggle("expanded", isHidden);
      }
      if (header) {
        header.setAttribute("aria-expanded", isHidden.toString());
      }
    }

    function csvEscape(value) {
      const text = String(value ?? "");
      if (/[",\n]/.test(text)) {
        return `"${text.replace(/"/g, '""')}"`;
      }
      return text;
    }

    function exportCsv() {
      const rows = [];
      rows.push([
        "id",
        "title",
        "status",
        "severity",
        "frameworks",
        "section",
        "cis_level",
        "stig_ids",
        "excluded",
        "recommendation",
      ]);

      document.querySelectorAll(".control").forEach((control) => {
        const row = [
          control.dataset.id,
          control.dataset.title,
          control.dataset.status,
          control.dataset.severity,
          control.dataset.frameworks,
          control.dataset.section,
          control.dataset.cisLevel,
          control.dataset.stigIds,
          control.dataset.excluded === "true" ? "yes" : "no",
          control.dataset.recommendation,
        ];
        rows.push(row);
      });

      const csv = rows.map((row) => row.map(csvEscape).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "bpa_report.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function getActiveFilter() {
      const active = document.querySelector(".filter-bar button.active");
      return active ? active.dataset.filter : "all";
    }

    function recalcSummary(filter) {
      const totalEl = document.getElementById("summary-total");
      const failEl = document.getElementById("summary-fail");
      const passEl = document.getElementById("summary-pass");
      const donut = document.getElementById("pf-donut");
      const donutTotal = document.getElementById("donut-total");
      const donutPass = document.getElementById("donut-pass");
      const donutFail = document.getElementById("donut-fail");

      if (!totalEl || !failEl || !passEl) {
        return;
      }

      const activeFilter = filter || "all";
      let total = 0;
      let fail = 0;
      let pass = 0;

      document.querySelectorAll(".control").forEach((control) => {
        if (control.dataset.excluded === "true") {
          return;
        }
        if (control.dataset.status === "manual") {
          return;
        }
        const frameworks = (control.dataset.frameworks || "")
          .split(",")
          .map((s) => s.trim());
        if (activeFilter !== "all" && !frameworks.includes(activeFilter)) {
          return;
        }
        total += 1;
        if (control.dataset.status === "fail") {
          fail += 1;
        } else if (control.dataset.status === "pass") {
          pass += 1;
        }
      });

      totalEl.textContent = total;
      failEl.textContent = fail;
      passEl.textContent = pass;

      if (donut && donutTotal && donutPass && donutFail) {
        donutTotal.textContent = total;
        donutPass.textContent = pass;
        donutFail.textContent = fail;

        const passDeg = total ? Math.round((pass / total) * 360) : 0;
        const failDeg = total ? Math.round((fail / total) * 360) : 0;
        donut.style.background = `conic-gradient(#28a745 0deg ${passDeg}deg, #ff4d4d ${passDeg}deg 360deg)`;
      }
    }

    function applyFilter(filter) {
      const controls = document.querySelectorAll(".control");
      controls.forEach((control) => {
        const frameworks = (control.dataset.frameworks || "")
          .split(",")
          .map((s) => s.trim());
        const show = filter === "all" || frameworks.includes(filter);
        control.style.display = show ? "" : "none";
      });

      document.querySelectorAll(".section").forEach((section) => {
        const anyVisible = Array.from(section.querySelectorAll(".control"))
          .some((control) => control.style.display !== "none");
        section.style.display = anyVisible ? "" : "none";
      });
      recalcSummary(filter);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".filter-bar button[data-filter]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".filter-bar button[data-filter]").forEach((b) => {
            b.classList.remove("active");
          });
          btn.classList.add("active");
          applyFilter(btn.dataset.filter);
        });
      });

      const exportBtn = document.getElementById("export-csv");
      if (exportBtn) {
        exportBtn.addEventListener("click", exportCsv);
      }

      document.querySelectorAll(".exclude-input").forEach((input) => {
        input.addEventListener("change", () => {
          const control = input.closest(".control");
          if (!control) {
            return;
          }
          const excluded = input.checked ? "true" : "false";
          control.dataset.excluded = excluded;
          control.classList.toggle("excluded", input.checked);
          recalcSummary(getActiveFilter());
        });
      });

      recalcSummary(getActiveFilter());
    });
  </script>
</head>

<body>

<div class="container">
  <div class="hero">
    <div class="hero-top">
      <div class="brand">
        <img src="/assets/panw-logo.svg" alt="Palo Alto Networks logo">
        <div class="brand-title">
          <h1>NGFW Best Practice Assessment (Offline) <span class="version">v1.0</span></h1>
          <span>Air-gapped CIS + STIG + PANW best practice review for PAN-OS configs (NGFW only; Panorama not supported)</span>
          <span class="feature-tag">Offline by Design: This tool runs entirely self-hosted. No data leaves the system, and no internet connectivity is required.</span>
        </div>
      </div>
    </div>
    <div class="notice">
      <strong>Notice:</strong> This is not an official Palo Alto Networks Best Practice Assessment tool.
      The supported and authoritative solution is available in Strata Cloud Manager
      (<a href="https://www.paloaltonetworks.com/network-security/strata-cloud-manager" target="_blank" rel="noopener noreferrer">
        paloaltonetworks.com/network-security/strata-cloud-manager
      </a>).
      Results produced by this tool are provided for informational purposes only and should be treated as guidance.
      Customers must independently validate all findings against their organization’s security requirements, policies,
      and risk tolerance.
    </div>
    <form class="upload" method="post" enctype="multipart/form-data" action="/assess">
      <input type="file" name="file" required>
      <button type="submit">Run Assessment</button>
    </form>
  </div>

{% if controls %}

<div class="summary">
  <div class="summary-box">
    <h3>Total</h3>
    <p id="summary-total">{{ controls | rejectattr("status","equalto","manual") | list | length }}</p>
  </div>
  <div class="summary-box">
    <h3>Failed</h3>
    <p id="summary-fail">{{ controls | selectattr("status","equalto","fail") | list | length }}</p>
  </div>
  <div class="summary-box">
    <h3>Passed</h3>
    <p id="summary-pass">{{ controls | selectattr("status","equalto","pass") | list | length }}</p>
  </div>

  {% set total_count = controls | rejectattr("status","equalto","manual") | list | length %}
  {% set pass_count = controls | selectattr("status","equalto","pass") | list | length %}
  {% set fail_count = controls | selectattr("status","equalto","fail") | list | length %}
  <div class="chart-card">
    <div class="donut" id="pf-donut">
      <div class="donut-center">
        <strong id="donut-total">{{ total_count }}</strong>
        <span>Checked</span>
      </div>
    </div>
    <div class="chart-legend">
      <div class="legend-row">
        <span class="legend-dot legend-pass"></span>
        <span>Pass: <strong id="donut-pass">{{ pass_count }}</strong></span>
      </div>
      <div class="legend-row">
        <span class="legend-dot legend-fail"></span>
        <span>Fail: <strong id="donut-fail">{{ fail_count }}</strong></span>
      </div>
    </div>
  </div>
</div>

{% if coverage %}
<div class="coverage">
  {% for item in coverage.metrics %}
  <div class="coverage-card">
    <h4>{{ item.label }}</h4>
    <div class="coverage-meta">
      <span>{{ item.count }} of {{ item.total }} allow rules</span>
      <span>{{ item.percent }}%</span>
    </div>
    <div class="coverage-bar">
      <div class="coverage-fill" style="width: {{ item.percent }}%"></div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="filter-bar" role="tablist" aria-label="Framework filters">
  <button type="button" class="active" data-filter="all">All</button>
  <button type="button" data-filter="CIS">CIS</button>
  <button type="button" data-filter="STIG">STIG</button>
  <button type="button" class="export-btn" id="export-csv">Export CSV</button>
</div>

{% for group in grouped_controls %}
{% set group_idx = loop.index %}
<div class="section">
  <h2>{{ group.framework }}</h2>
  <h3>{{ group.section }}</h3>
  {% if group.manual %}
  <p class="section-note">These checks cannot be automated and should be reviewed manually.</p>
  {% endif %}

{% for c in group.controls %}
{% set cid = "g" ~ group_idx ~ "_c" ~ loop.index %}
<div class="control"
     data-id="{{ c.id }}"
     data-title="{{ c.title }}"
     data-section="{{ c.section }}"
     data-severity="{{ c.severity }}"
     data-frameworks="{{ c.frameworks | join(',') }}"
     data-recommendation="{{ c.recommendation }}"
     data-cis-level="{{ c.cis_level }}"
     data-stig-ids="{{ c.stig_ids | join(',') }}"
     data-status="{{ c.status }}">
  <div class="control-header {{ c.status }}" onclick="toggle('{{ cid }}')" aria-expanded="false">
    <strong>{{ c.display_id }} — {{ c.title }}</strong>
    <div class="badges">
      {% if "CIS" in c.frameworks and c.cis_level %}
      <span class="cis">CIS {{ c.cis_level }}</span>
      {% endif %}
      {% if "STIG" in c.frameworks %}
      <span class="stig">
        <img src="/assets/stig-shield.svg" alt="STIG">STIG{% if c.stig_level %} L{{ c.stig_level }}{% endif %}
      </span>
      {% endif %}
      <span class="section-badge">{{ c.section }}</span>
      <span class="{{ c.status }}">{{ c.status|upper }}</span>
      <span class="expand-hint">Details <span class="chevron">▸</span></span>
      {% if c.status != "manual" %}
      <label class="exclude-toggle" title="Exclude from score" onclick="event.stopPropagation()">
        <input type="checkbox" class="exclude-input" onclick="event.stopPropagation()">
        Exclude
      </label>
      {% endif %}
    </div>
  </div>

  <div class="details" id="{{ cid }}">
    <p><strong>Category:</strong> {{ c.category }}</p>
    <p><strong>Severity:</strong> {{ c.severity }}</p>
    <p><strong>Recommendation:</strong> {{ c.recommendation }}</p>

    {% if c.findings %}
      <h4>Failing Rules</h4>

      {% for r in c.findings %}
      <div class="rule">
        {% if r.setting is defined %}
          <strong>{{ r.setting }}</strong><br>
          {% if r.reason %}
          <small><strong>Why failed:</strong> {{ r.reason }}</small><br>
          {% endif %}
          <small>
            Expected: {{ r.expected }} |
            Actual: {{ r.actual if r.actual else "not set" }}
          </small>
        {% else %}
          <strong>{{ r.name }}</strong><br>
          {% if r.vsys %}
          <small>vsys: {{ r.vsys }}</small><br>
          {% endif %}
          {% if r.reason %}
          <small><strong>Why failed:</strong> {{ r.reason }}</small><br>
          {% endif %}
          <small>
            From: {{ r.from | join(", ") }} |
            To: {{ r.to | join(", ") }} |
            App: {{ r.application | join(", ") }} |
            Service: {{ r.service | join(", ") }} |
            Action: {{ r.action }}
          </small>
        {% endif %}

        {% if r.profile_status is defined %}
          <div>
            {% for label, ok in r.profile_status.items() %}
              {{ label }}:
              {% if ok %}
                <span class="ok">✔ Present</span>
              {% else %}
                <span class="bad">✖ Missing</span>
              {% endif %}
              <br>
            {% endfor %}
          </div>
        {% endif %}
      </div>
      {% endfor %}

    {% else %}
      {% if c.status == "pass" %}
        {% if c.scope == "rules" and c.rule_count and c.rule_count > 0 %}
          <em>Evaluated {{ c.rule_count }} allow rules; no violations found.</em>
        {% else %}
          <em>Actual: set</em>
        {% endif %}
      {% else %}
        <em>No rule-level findings were attached to this control.</em>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endfor %}
</div>
{% endfor %}

{% endif %}
<div class="site-footer">
  <div>Licensed under the Apache License, Version 2.0.</div>
  <div>© 2025 Mark Allen.</div>
  <div>
    This is a community-developed, open-source project and is not affiliated with,
    endorsed by, or supported by Palo Alto Networks.
  </div>
</div>

</div>

</body>
</html>
